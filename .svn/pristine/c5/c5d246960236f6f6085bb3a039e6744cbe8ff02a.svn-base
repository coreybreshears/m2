# Function Controller
class FunctionsController < ApplicationController
  include FunctionsHelper
  require 'yaml'
  layout :determine_layout
  before_filter :check_localization
  before_filter :authorize
  before_filter :admin_only, only: [:background_tasks, :task_delete, :task_restart, :get_mnp_prefixes,
                                    :create_mnp_prefix, :delete_mnp_prefix, :test_mnp_db_connection]
  before_filter :test_email_admin_only, only: [:send_test_email]
  before_filter :disable_xss_protection, only: [:settings]
  before_filter :check_if_request_ajax, only: [:get_mnp_prefixes, :create_mnp_prefix, :delete_mnp_prefix, :test_mnp_db_connection]
  before_action :find_user, only: %i(login_as_execute)

  $date_formats = [
    '%Y-%m-%d %H:%M:%S', '%Y/%m/%d %H:%M:%S', '%Y,%m,%d %H:%M:%S', '%Y.%m.%d %H:%M:%S', '%d-%m-%Y %H:%M:%S',
    '%d/%m/%Y %H:%M:%S', '%d,%m,%Y %H:%M:%S', '%d.%m.%Y %H:%M:%S', '%m-%d-%Y %H:%M:%S', '%m/%d/%Y %H:%M:%S',
    '%m,%d,%Y %H:%M:%S', '%m.%d.%Y %H:%M:%S'
  ]
  $decimal_formats = %w[. , ;]
  $time_formats = ['%H:%M:%S', '%M:%S']

  def index
    redirect_to(:root) && (return false)
  end

  #================= LOGIN AS ==================

  def login_as
    @page_title = _('Login_as')
    @page_icon = 'key.png'
    @help_link = 'http://wiki.ocean-tel.uk/index.php/Login_as'

    @users = User.select("*, #{SqlExport.nice_user_sql}").where("hidden = 0 AND owner_id = 0 AND id != #{current_user.id}").order('nice_user ASC')
  end

  def login_as_execute
    owner_id = manager? ? 0 : current_user.id
    if !(admin? || manager?) && @user.owner_id.to_i != owner_id || !User.check_responsability(params[:user])
      dont_be_so_smart
      redirect_to(:root) && (return false)
    end
    @login_ok = true

    store_url

    renew_session(@user)
    # Session is synced with the last password change
    session[:session_token] = @user.password_changed_at if Confline.get_value('logout_on_password_change').to_i == 1

    @user.mark_logged_in

    change_date_to_present
    session.delete(:calls_list)
    session.delete(:aggregate_list_options)
    session.delete(:summary_list_options)
    flash[:first_login] = true
    redirect_to(:root) && (return false)
  end

  def settings
    @page_title = _('Settings')
    @page_icon = 'cog.png'
    @help_link = 'http://wiki.ocean-tel.uk/index.php/Configuration_from_GUI'

    @countries = Direction.order('name ASC')
    @tariffs = Tariff.where("owner_id = '#{session[:user_id]}'").order('purpose ASC, name ASC')
    @currencies = Currency.get_active
    @servers = Server.order('id ASC')

    style(Confline.get_value('Usual_text_font_style').to_i)
    @style_one = @ar[2]
    @style_two = @ar[1]
    @style_three = @ar[0]
    style(Confline.get_value('Usual_text_highlighted_text_style').to_i)
    @style_four = @ar[2]
    @style_five = @ar[1]
    @style_six = @ar[0]
    style(Confline.get_value('Header_footer_font_style').to_i)
    @style_seven = @ar[2]
    @style_eight = @ar[1]
    @style_nine = @ar[0]

    @logo = Confline.get_value('Logo_Picture')

    @recaptcha_public_key = Confline.get_value('ReCAPTCHA_public_key')
    @recaptcha_private_key = Confline.get_value('ReCAPTCHA_private_key')

    @agreement = Confline.get('Registration_Agreement', session[:user_id])

    archive_at = Confline.get_value('Archive_at', 0)
    archive_till = Confline.get_value('Archive_till', 0)

    if archive_at.blank? || archive_at.to_i == -1
      @archive_at_hour = @archive_at_minute = nil
    else
      time_at = Time.parse(archive_at).in_time_zone(user_tz)
      @archive_at_hour = time_at.strftime('%H')
      @archive_at_minute = time_at.strftime('%M')
    end

    if archive_till.blank? || archive_till.to_i == -1
      @archive_till_hour = @archive_till_minute = nil
    else
      time_till = Time.parse(archive_till).in_time_zone(user_tz)
      @archive_till_hour = time_till.strftime('%H')
      @archive_till_minute = time_till.strftime('%M')
    end
    @mnp_prefixes = MnpPrefix.all
  end

  def send_test_email
    @emails = Email.where(["owner_id= ? AND (callcenter='0' OR callcenter IS NULL)", session[:user_id]])

    if @emails.size.to_i == 0 && session[:usertype] == 'reseller'
      user = User.find(session[:user_id])
      user.create_reseller_emails
    end

    @num = EmailsController.send_test(session[:user_id])
    @num == _('Email_sent').to_s ? flash[:status] = @num : flash[:notice] = notice_with_info_help(@num + '.', 'http://wiki.ocean-tel.uk/index.php/Configuration_from_GUI#Emails')

    if ['admin', 'manager'].include?(session[:usertype])
      redirect_to action: 'settings'
    else
      redirect_to :root
    end
  end

  def settings_change
    if invalid_api_params? params[:allow_api], params[:api_secret_key]
      flash[:notice] = _('invalid_api_secret_key')
      redirect_to(action: 'settings') && (return false)
    end

    params[:email_from] = params[:email_from].to_s.downcase.strip
    if (params[:email_sending_enabled].to_i == 1 && params[:email_from].to_s.blank?) || (params[:email_from].to_s.present? and not params[:email_from].to_s =~ /^[_a-z0-9-]+(\.[_a-z0-9-]+)*@[a-z0-9-]+(\.[a-z0-9-]+)*(\.[a-z]{2,4})$/)
      flash[:notice] = _('Invalid_email_format_in_emails_from')
      redirect_to(action: 'settings') && (return false)
    end

    max_pages = Confline.get_value('Max_PDF_pages')
    max_pages = max_pages.blank? ? 100 : max_pages.to_i

    # ==== LOGO ====
    if params[:logo]
      @file = params[:logo]
      unless @file.empty?
        if @file.size < 102400
          @filename = sanitize_filename(@file.original_filename)
          @ext = @filename.split('.').last.downcase
          if @ext == 'jpg' || @ext == 'jpeg' || @ext == 'png' || @ext == 'gif'
            File.open(Actual_Dir + '/public/images/logo/' + @filename, 'wb') do |file|
              file.write(params[:logo].read)
            end
            update_confline('Logo_Picture', 'logo/' + @filename)
            user = User.find(session[:user_id])
            renew_session(user, {dont_change_date: true})
          else
            flash[:notice] = _('Not_a_picture')
            redirect_to(action: 'settings') && (return false)
          end
        else
          flash[:notice] = _('Logo_to_big_max_size_100kb')
          redirect_to(action: 'settings') && (return false)
        end
      else
        flash[:notice] = _('Zero_size_file')
        redirect_to(action: 'settings') && (return false)
      end
    end

    error = 0
    # Globals
    update_confline('Company', params[:company])
    update_confline('Company_Email', params[:company_email])
    update_confline('Version', params[:version])
    update_confline('Copyright_Title', params[:copyright_title])
    update_confline('Admin_Browser_Title', params[:admin_browser_title])
    Confline.set_value2('Frontpage_Text', params[:frontpage_text].to_s, session[:user_id])
    Confline.set_value2('Login_page_Text', params[:login_page_text].to_s, session[:user_id])
    # Registration

    update_confline('Registration_enabled', params[:registration_enabled])
    Confline.set_value('Hide_registration_link', params[:hide_registration_link])
    update_confline('Tariff_for_registered_users', params[:tariff_for_registered_users])
    update_confline('Default_Country_ID', params[:default_country_id])
    update_confline('Default_CID_Name', params[:default_cid_name])
    update_confline('Default_CID_Number', params[:default_cid_number])
    update_confline('Send_Email_To_User_After_Registration', params[:send_email_to_user_after_registration])
    update_confline('Send_Email_To_Admin_After_Registration', params[:send_email_to_admin_after_registration])
    Confline.set_value('Default_Balance_for_new_user', params[:default_balance_for_new_user].to_d)
    params_recaptcha_private_key = params[:recaptcha_private_key].to_s
    params_recaptcha_public_key = params[:recaptcha_public_key].to_s
    params_enable_recaptcha = params[:enable_recaptcha].to_i

    if params_enable_recaptcha == 0 || (params_enable_recaptcha == 1 && params_recaptcha_public_key.present? && params_recaptcha_private_key.present?)
      Confline.set_value('reCAPTCHA_enabled', params_enable_recaptcha)
      Confline.set_value('ReCAPTCHA_public_key', params_recaptcha_public_key.strip)
      Confline.set_value('ReCAPTCHA_private_key', params_recaptcha_private_key.strip)
      Recaptcha.configure do |config|
        config.public_key = Confline.get_value('reCAPTCHA_public_key')
        config.private_key = Confline.get_value('reCAPTCHA_private_key')
      end
    end
    Confline.set_value('Allow_registration_username_passwords_in_devices', params[:allow_registration_username_passwords_in_devices].to_i)
    Confline.set_value('Registration_Enable_VAT_checking', params[:enable_vat_checking].to_i)
    Confline.set_value('Registration_allow_vat_blank', params[:allow_vat_blank].to_i)

    Confline.set_value('Invoice_user_billsec_show', params[:invoice_user_billsec_show].to_i)

    # Invoices
    update_confline('Invoice_Number_Start', params[:invoice_number_start])
    params[:invoice_number_length] = validate_range(params[:invoice_number_length], 1, 20, 5).to_i
    update_confline('Invoice_Number_Length', params[:invoice_number_length])
    update_confline('Invoice_Number_Type', params[:invoice_number_type])
    update_confline('convert_xlsx_to_pdf', params[:convert_xlsx_to_pdf].to_i, manager? ? 0 : session[:user_id])
    Confline.set_value('Invoice_email_notice_admin', params[:invoice_email_notice_admin].to_i)
    Confline.set_value('Invoice_email_notice_manager', params[:invoice_email_notice_manager].to_i)
    Confline.set_value('How_often_to_send_email_notice', params[:send_email_notice].to_i)
    Confline.set_value('Invoice_Group_By', params[:invoice_group_by].to_i)
    Confline.set_value('Invoice_Group_By_Destination', params[:invoice_group_by_destination].to_i)
    Confline.set_value('Show_Rates', params[:invoice_show_rates].to_i)
    Confline.set_value('Duration_Format', params[:duration_format].to_s, 0)
    Confline.set_value('Duration_Format_Minute_Precision', params[:duration_format_minute_precision].to_i, 0)
    Confline.set_value('Do_not_generate_Invoices_for_blocked_Users', params[:do_not_generate_invoices_for_blocked_users].to_i)
    Confline.set_value('Do_not_include_currencies', params[:do_not_include_currencies].to_i)
    invoice_cells = M2Invoice.xlsx_template_cells
    cell_values = []
    invoice_cells.each { |name_of_cell| cell_values << params[name_of_cell.to_sym].to_s.upcase.strip }
    array_without_empty_values = cell_values.reject(&:empty?)

    if array_without_empty_values.uniq.length != array_without_empty_values.length
      flash[:notice] = _('duplicate_value_in_cell_address_field')
      error = 1
    else
      invoice_cells.each do |cell_name|
        param_of_cell = params[cell_name.to_sym]
        full_cell_name = 'Cell_m2_' + cell_name
        session_user_id = manager? ? 0 : session[:user_id]

        if param_of_cell.blank?
          update_confline(full_cell_name, '', session_user_id)
        elsif param_of_cell =~ /^([a-zA-Z]([0]*[1-9]+|[1-9]+\d+)+\s*)$/
          update_confline(full_cell_name, param_of_cell.to_s.upcase.strip, session_user_id)
        else
          flash[:notice] = _('value_does_not_match_cell_address_format')
          error = 1
        end
      end
    end
    copy_file('public/invoice_templates', 'default.xlsx')

    if params[:new_xlsx_template_apply_for_old_invoices].to_i == 1
      delete_generated_invoice_xlsx_files(correct_owner_id)
    end

    # Emails

    update_confline('Email_Sending_Enabled', params[:email_sending_enabled])
    update_confline('Email_Smtp_Server', params[:email_smtp_server])
    # set default param in model
    # update_confline('Email_Domain', params[:email_domain])

    update_confline('Email_Batch_Size', params[:email_batch_size])
    update_confline('Email_from', params[:email_from])
    update_confline('Email_port', params[:email_port])
    update_confline('Email_Login', params[:email_login])
    update_confline('Email_Password', params[:email_password])

    # Realtime
    if params[:time].to_i < 15
      update_confline('Realtime_reload_time', '15')
    else
      update_confline('Realtime_reload_time', params[:time])
    end

    update_confline('Usual_text_font_color', params[:colorfield1])
    update_confline('Usual_text_font_size', params[:usual_text_font_size])
    @usual_text_font_style = params[:style_one].to_i + params[:style_two].to_i + params[:style_three].to_i
    update_confline('Usual_text_font_style', @usual_text_font_style.to_s)
    update_confline('Usual_text_highlighted_text_color', params[:colorfield2])
    @usual_text_highlighted_text_style = params[:style_four].to_i + params[:style_five].to_i + params[:style_six].to_i
    update_confline('Usual_text_highlighted_text_style', @usual_text_highlighted_text_style.to_s)
    update_confline('Usual_text_highlighted_text_size', params[:usual_text_highlighted_text_size])
    update_confline('Header_footer_font_color', params[:colorfield3])
    update_confline('Header_footer_font_size', params[:h_f_font_size])
    @h_f_font_style = params[:style_seven].to_i + params[:style_eight].to_i + params[:style_nine].to_i
    update_confline('Header_footer_font_style', @h_f_font_style.to_s)
    update_confline('Background_color', params[:colorfield4])
    update_confline('Row1_color', params[:colorfield5])
    update_confline('Row2_color', params[:colorfield6])
    update_confline('3_first_rows_color', params[:colorfield7])

    # Various

    server_free_space_limit = params[:server_free_space_limit]
    if is_number?(server_free_space_limit) && (0..100).include?(server_free_space_limit.to_i)
      update_confline('server_free_space_limit', server_free_space_limit)
    else
      update_confline('server_free_space_limit', 20)
    end
    Confline.set_value('admin_login_with_approved_ip_only', params[:admin_login_with_approved_ip_only].to_i)
    Confline.set_value('bad_login_ip_report_warning', params[:bad_login_ip_report_warning].to_i)
    Confline.set_value('call_tracing_server', params[:call_tracing_server].to_i)
    Confline.set_value('do_not_logout_on_session_ip_change', params[:do_not_logout_on_session_ip_change].to_i) if admin?

    delete_tariff_jobs_older_than = params[:delete_tariff_jobs_older_than]
    if is_number?(delete_tariff_jobs_older_than) && (delete_tariff_jobs_older_than.to_i >= 7)
      update_confline('Delete_Tariff_Jobs_older_than', delete_tariff_jobs_older_than)
    else
      flash[:notice] = _('Delete_Tariff_Jobs_older_than_value_must_be_equal_or_greater_than_7')
      error = 1
    end
    # /Various

    # Tax
    params[:total_tax] = 'TAX' if params[:total_tax].blank?
    params[:tax1name] = params[:total_tax].to_s if params[:tax1name].blank?

    Confline.set_value('Tax_1', params[:tax1name])
    Confline.set_value('Tax_2', params[:tax2name])
    Confline.set_value('Tax_3', params[:tax3name])
    Confline.set_value('Tax_4', params[:tax4name])
    Confline.set_value('Tax_1_Value', params[:tax1value].to_d)
    Confline.set_value('Tax_2_Value', params[:tax2value].to_d)
    Confline.set_value('Tax_3_Value', params[:tax3value].to_d)
    Confline.set_value('Tax_4_Value', params[:tax4value].to_d)
    Confline.set_value('Total_tax_name', params[:total_tax])
    Confline.set_value('Tax_compound', params[:compound_tax].to_i, session[:user_id])

    Confline.set_value2('Tax_1', '1') # for consistency.
    Confline.set_value2('Tax_2', params[:tax2active].to_i)
    Confline.set_value2('Tax_3', params[:tax3active].to_i)
    Confline.set_value2('Tax_4', params[:tax4active].to_i)
    # /Tax
    Confline.set_value('Agreement_Number_Length', params[:agreement_number_length])
    Confline.set_value('Nice_Number_Digits', params[:nice_number_digits])

    nice_currency_digits = params[:nice_currency_digits].to_i
    if nice_currency_digits < 1
      flash[:notice] = _('Currency_Amount_Number_Digits_must_be_greater_than_0')
      error = 1
    else
      Confline.set_value('Nice_Currency_Digits', nice_currency_digits)
    end

    if params[:items_per_page].to_i < 1
      flash[:notice] = _('Items_Per_Page_mus_be_greater_than_0')
      error = 1
    else
      Confline.set_value('Items_Per_Page', params[:items_per_page].to_i)
    end

    Confline.set_value('Date_format', params[:date_format])
    Confline.set_value('time_format', params[:time_format])
    Confline.set_value('Device_PIN_Length', params[:device_pin_length])
    Confline.set_value('Hide_non_completed_payments_for_user', params[:hide_non_completed_payments_for_user].to_i)
    Confline.set_value('Disallow_Email_Editing', params[:disallow_email_editing], corrected_user_id)
    Confline.set_value('Disallow_Details_Editing', params[:disallow_details_editing], corrected_user_id)
    Confline.set_value('System_time_zone_daylight_savings', params[:system_time_zone_daylight_savings].to_i)
    Confline.set_value('Show_Usernames_On_Pdf_Csv_Export_Files_In_Last_Calls', params[:show_usernames_on_pdf_csv_export_files_in_last_calls].to_i)
    Confline.set_value('Use_strong_passwords_for_users', params[:use_strong_passwords_for_users].to_i)
    Confline.set_value('Archive_only_answered_calls', params[:archive_only_answered_calls])
    Confline.set_value('Archive_Calls_to_CSV', params[:archive_calls_to_csv])
    Confline.set_value('Do_not_delete_Archived_Calls_from_calls_table', params[:do_not_delete_archived_calls_from_calls_table])
    Confline.set_value('Delete_Calls_instead_of_Archiving', params[:delete_calls_instead_of_archiving])
    Confline.set_value('invoices_show_username', params[:invoices_show_username].to_i)

    Confline.set_value('AD_Sounds_Folder', params[:ad_sound_folder])
    Confline.set_value('Logout_link', params[:logout_link])

    archive_at = if [params[:archive_at_hour], params[:archive_at_minute]].member?('-1')
                   '-1'
                 else
                   Time.zone.now.change(hour: params[:archive_at_hour], min: params[:archive_at_minute]).localtime.strftime('%H:%M')
                 end

    archive_till = if [params[:archive_till_hour], params[:archive_till_minute]].member?('-1')
                     '-1'
                   else
                     Time.zone.now.change(hour: params[:archive_till_hour], min: params[:archive_till_minute]).localtime.strftime('%H:%M')
                   end

    Confline.set_value('Archive_at', archive_at)
    Confline.set_value('Archive_till', archive_till)

    if ('0'..'3650').member? params[:archive_when]
      Confline.set_value('Move_to_old_calls_older_than', params[:archive_when].to_i)
    else
      flash[:notice] = _('Archive_when_invalid')
      error = 1
    end

    if ('0'..'3650').member? params[:delete_archived_calls_older_than]
      Confline.set_value('Delete_Archived_Calls_older_than', params[:delete_archived_calls_older_than].to_i)
    else
      flash[:notice] = _('Archive_when_invalid')
      error = 1
    end

    if ('0'..'3650').member? params[:delete_not_archived_not_answered_calls_older_than]
      Confline.set_value('Delete_not_Archived_not_Answered_Calls_older_than', params[:delete_not_archived_not_answered_calls_older_than].to_i)
    else
      flash[:notice] = _('Archive_when_invalid')
      error = 1
    end

    # With this setting users are logged out when their passwords change
    pswd_change_old = Confline.get_value('logout_on_password_change').to_i
    pswd_change_new = params[:logout_on_password_change] || 0
    if pswd_change_new != pswd_change_old
      Confline.set_value('logout_on_password_change', pswd_change_new)
      ActiveRecord::Base.connection.execute('UPDATE users SET password_changed_at = NULL')
    end

    # FUNCTIONALITY
    if params[:delete_not_actual_rates_after].to_d < 0
      flash[:notice] = _('delete_not_actual_rates_after_greater')
      error = 1
    elsif not is_number?(params[:delete_not_actual_rates_after].to_s)
      flash[:notice] = _('delete_not_actual_rates_after_integer')
      error = 1
    else
      Confline.set_value('delete_not_actual_rates_after', params[:delete_not_actual_rates_after].to_i)
    end

    # FUNCTIONALITY
    Confline.set_value('Show_Rates_Without_Tax', params[:show_rates_without_tax], session[:user_id])
    ## Check if decimal separator and CSV separator are not equal.
    if params[:csv_separator] != params[:csv_decimal]
      Confline.set_value('CSV_Separator', params[:csv_separator])
      Confline.set_value('CSV_Decimal', params[:csv_decimal])
    end
    Confline.set_value('Show_Full_Src', params[:show_full_src]) unless params[:XML_API_Extension] == 1

    Confline.set_value('Active_Calls_Maximum_Calls', params[:active_calls_max])
    Confline.set_value('Active_Calls_Refresh_Interval', ((params[:active_calls_interval].to_i < 3) ? 3 : params[:active_calls_interval].to_i))
    Confline.set_value('Show_Active_Calls_for_Users', params[:show_active_calls_for_users])
    Confline.set_value('Active_Calls_Show_Server', params[:active_calls_show_server])
    Confline.set_value('Show_logo_on_register_page', (params[:show_logo_on_register_page] ? params[:show_logo_on_register_page] : 0))
    Confline.set_value('Show_rates_for_users', params[:show_rates_for_users].to_i, session[:user_id])
    Confline.set_value('Hide_payment_options_for_postpaid_users', params[:hide_payment_options_for_postpaid_users].to_i, session[:user_id])
    Confline.set_value('Hide_HELP_banner', params[:hide_help_banner].to_i, session[:user_id])
    Confline.set_value('Hide_Iwantto', params[:hide_iwantto].to_i)
    Confline.set_value('Hide_Device_Passwords_For_Users', params[:hide_device_passwords_for_users].to_i, 0)
    Confline.set_value('Show_only_main_page', params[:show_only_main_page].to_i, 0)
    Confline.set_value('Show_forgot_password', params[:show_forgot_password].to_i, 0)
    Confline.set_value('Show_Calls_statistics_to_User_for_last', Application.nice_unsigned_integer(params[:show_calls_stats_to_user_for_last]), corrected_user_id)
    Confline.set_value('Show_device_and_cid_in_last_calls', params[:show_device_and_cid_in_last_calls], 0)

    Confline.set_value('Show_answer_time_last_calls', params[:show_answer_time_last_calls], 0)
    Confline.set_value('Show_end_time_last_calls', params[:show_end_time_last_calls], 0)
    Confline.set_value('Show_PDD_last_calls', params[:show_PDD_last_calls], 0)
    Confline.set_value('Show_terminated_by_last_calls', params[:show_terminated_by_last_calls], 0)
    Confline.set_value('Show_Duration_in_Last_Calls', params[:show_duration_in_last_calls].to_i, 0)
    Confline.set_value('Retrieve_PCAP_files_from_the_Proxy_Server', params[:retrieve_pcap_files_from_the_proxy_server].to_i, 0)
    Confline.set_value('GDPR_Activated', params[:gdpr_activated].to_i, 0) if admin?
    Confline.set_value('show_rates_in_active_calls', params[:show_rates_in_active_calls], 0)
    CdrExportTemplate.update_setting_changes if params[:show_device_and_cid_in_last_calls].to_i == 0
    Confline.set_value('Show_detailed_quick_stats', params[:detailed_quick_stats_active], 0)
    Confline.set_value('Cache_ES_Sync_Status_for_last', Application.nice_unsigned_integer(params[:cache_es_sync_status_for_last]), corrected_user_id)

    # ==== Calls Dashboard settings ==== #
    # Refresh period settings
    cd_refresh_period = params[:cd_refresh_interval].to_i

    if cd_refresh_period > 0
      Confline.set_value('Calls_Dashboard_refresh_interval', cd_refresh_period)
    else
      flash[:notice] = _('Calls_Dashboard_bad_interval')
      error = 1
    end

    # Color range settings
    bad_asr = params[:bad_asr].to_s.strip
    good_asr = params[:good_asr].to_s.strip

    bad_acd = params[:bad_acd].to_s.strip
    good_acd = params[:good_acd].to_s.strip

    bad_margin = params[:bad_margin].to_s.strip
    good_margin = params[:good_margin].to_s.strip
    cd_errors = 0

    # Color ranges must be integers and must not overlap
    range_checker = proc { |param| param.blank? || param =~ %r{^\-?[0-9]+$} }
    if [bad_asr, good_asr, bad_acd, good_acd, bad_margin, good_margin].all?(&range_checker)
      if bad_asr.blank? || good_asr.blank? || bad_asr.to_i <= good_asr.to_i
        Confline.set_value('CD_bad_ASR', bad_asr)
        Confline.set_value('CD_good_ASR', good_asr)
      else
        cd_errors += 1
      end
      if bad_acd.blank? || good_acd.blank? || bad_acd.to_i <= good_acd.to_i
        Confline.set_value('CD_bad_ACD', bad_acd)
        Confline.set_value('CD_good_ACD', good_acd)
      else
        cd_errors += 1
      end
      if bad_margin.blank? || good_margin.blank? || bad_margin.to_i <= good_margin.to_i
        Confline.set_value('CD_bad_Margin', bad_margin)
        Confline.set_value('CD_good_Margin', good_margin)
      else
        cd_errors += 1
      end
    else
      cd_errors += 1
    end

    if cd_errors > 0
      flash[:notice] = _('Calls_Dashboard_bad_color_range')
      error = 1
    end
    # ==== End of Calls Dashboard settings ==== #

    # Backups Confline.set_value
    # Confline.set_value('Backup_Folder', params[:backup_storage_directory])
    if params[:backup_number].to_i >= 3 and params[:backup_number].to_i <= 50
      Confline.set_value('Backup_number', params[:backup_number].to_i)
    else
      Confline.set_value('Backup_number', 3)
    end

    if params[:backup_disk_space].to_i >= 10 and params[:backup_disk_space].to_i <= 100
      Confline.set_value('Backup_disk_space', params[:backup_disk_space].to_i)
    else
      Confline.set_value('Backup_disk_space', 10)
    end

    if params[:archive_calls_to_csv] == '2'
      Confline.set_value('save_archived_calls_on_ftp', 1)
    else
      Confline.set_value('save_archived_calls_on_ftp', 0)
    end
    Confline.set_value('ftp_host', params[:ftp_host])
    Confline.set_value('ftp_port', params[:ftp_port])
    Confline.set_value('ftp_user', params[:ftp_user])
    Confline.set_value('ftp_pass', params[:ftp_pass])
    Confline.set_value('ftp_archived_calls_path', params[:ftp_archived_calls_path])
    Confline.set_value('ftp_backups_path', params[:ftp_backups_path])
    Confline.set_value('store_backups_on_ftp', params[:store_backups_on_ftp])

    if params[:store_backups_on_ftp].to_i == 1
      unless Backup.ftp_test_connection(params[:ftp_backups_path])
        Confline.set_value('store_backups_on_ftp', 0)
        flash[:notice] = _('Wrong_FTP_Credentials')
      end
    end

    if Confline.get_value('save_archived_calls_on_ftp').to_i == 1
      unless Backup.ftp_test_connection(params[:ftp_backups_path])
        Confline.set_value('save_archived_calls_on_ftp', 0)
        Confline.set_value('archive_calls_to_csv', 0)
        flash[:notice] = _('Wrong_FTP_Credentials')
      end
    end

    Confline.set_value('Backup_Exclude_Calls_Old', params[:exclude_archived_calls_table])
    Confline.set_value('Backup_shedule', params[:shedule])
    Confline.set_value('Backup_month', params[:backup_month])
    if ((params[:backup_month].to_i.odd? and (params[:backup_month].to_i > 8)) or (params[:backup_month].to_i.even? and (params[:backup_month].to_i < 7))) and params[:backup_month_day].to_i >= 29
      params[:backup_month_day] = 30 if params[:backup_month_day].to_i >= 30
      if params[:backup_month].to_i == 2
        params[:backup_month_day] = 28
      end
    end
    Confline.set_value('Backup_month_day', params[:backup_month_day])
    Confline.set_value('Backup_week_day', params[:backup_week_day])
    Confline.set_value('Backup_hour', params[:hour])

    # API settings
    Confline.set_value('Allow_API', params[:allow_api].to_i)
    unless params[:allow_api].to_i.zero?
      Confline.set_value('Allow_GET_API', params[:allow_get_api].to_i)
      Confline.set_value('API_Secret_Key', params[:api_secret_key].to_s.strip)
      Confline.set_value('XML_API_Extension', params[:xml_api_extension].to_i)
      Confline.set_value('API_Login_Redirect_to_Main', params[:api_login_redirect_to_main].to_i)
      Confline.set_value('API_Allow_payments_ower_API', params[:api_allow_payments].to_i)
      Confline.set_value('Devices_Check_Ballance', params[:devices_check_ballance])
      Confline.set_value('API_Disable_hash_checking', params[:api_disable_hash_checking].to_i)
    end
    # /API settings

    Confline.set_value('CSV_File_size', params[:csv_file_size].to_i)

    # terms and conditions
    cl = Confline.find_or_create_by(name: 'Registration_Agreement', owner_id: session[:user_id])
    if params[:use_terms_and_conditions]
      cl.update_attributes(value2: params[:terms_and_conditions], value: '1')
    else
      cl.update_attribute(:value, '0')
    end

    Confline.set_value('Change_ANSWER_to_FAILED_if_HGC_not_equal_to_16_for_Users', params[:change_if_hgc_not_equal_to_16_for_users].to_i)
    Confline.set_value('Global_Number_Decimal', params[:global_number_decimal].to_s)

    tb = Confline.get_value('Tell_Balance').to_i
    tt = Confline.get_value('Tell_Time').to_i
    Confline.set_value('Tell_Balance', params[:tell_balance].to_i)
    Confline.set_value('Tell_Time', params[:tell_time].to_i)

    sip_port = (params[:default_sip_device_port].to_i == 0) ? 5060 : params[:default_sip_device_port].to_i
    Confline.set_value('Default_SIP_device_port', sip_port, current_user.get_corrected_owner_id)

    # Server Load

    params[:gui_hdd_utilisation] = 100 if params[:gui_hdd_utilisation].to_i > 100
    params[:gui_hdd_utilisation] = 0 if params[:gui_hdd_utilisation].to_i < 0
    Confline.set_value('GUI_HDD_utilisation', params[:gui_hdd_utilisation].to_i)

    params[:gui_hdd_general_load] = 1000 if params[:gui_hdd_general_load].to_i > 1000
    params[:gui_hdd_general_load] = 0 if params[:gui_hdd_general_load].to_i < 0
    Confline.set_value('GUI_CPU_General_load', params[:gui_hdd_general_load].to_i)

    params[:gui_hdd_loadstats] = 50.0 if params[:gui_hdd_loadstats].to_d > 50.0
    params[:gui_hdd_loadstats] = 0.0 if params[:gui_hdd_loadstats].to_d < 0.0
    Confline.set_value('GUI_CPU_Loadstats', params[:gui_hdd_loadstats].to_d.round(1))

    params[:gui_hdd_ruby_process] = 1000 if params[:gui_hdd_ruby_process].to_i > 1000
    params[:gui_hdd_ruby_process] = 0 if params[:gui_hdd_ruby_process].to_i < 0
    Confline.set_value('GUI_CPU_Ruby_process', params[:gui_hdd_ruby_process].to_i)

    params[:gui_hdd_asterisk_process] = 1000 if params[:gui_hdd_asterisk_process].to_i > 1000
    params[:gui_hdd_asterisk_process] = 0 if params[:gui_hdd_asterisk_process].to_i < 0
    Confline.set_value('GUI_CPU_asterisk_process', params[:gui_hdd_asterisk_process].to_i)

    params[:gui_hdd_freeswitch_process] = 1000 if params[:gui_hdd_freeswitch_process].to_i > 1000
    params[:gui_hdd_freeswitch_process] = 0 if params[:gui_hdd_freeswitch_process].to_i < 0
    Confline.set_value('GUI_CPU_freeswitch_process', params[:gui_hdd_freeswitch_process].to_i)

    params[:db_hdd_utilisation] = 100 if params[:db_hdd_utilisation].to_i > 100
    params[:db_hdd_utilisation] = 0 if params[:db_hdd_utilisation].to_i < 0
    Confline.set_value('DB_HDD_utilisation', params[:db_hdd_utilisation].to_i)

    params[:db_hdd_general_load] = 1000 if params[:db_hdd_general_load].to_i > 1000
    params[:db_hdd_general_load] = 0 if params[:db_hdd_general_load].to_i < 0
    Confline.set_value('DB_CPU_General_load', params[:db_hdd_general_load].to_i)

    params[:db_hdd_loadstats] = 50.0 if params[:db_hdd_loadstats].to_d > 50.0
    params[:db_hdd_loadstats] = 0.0 if params[:db_hdd_loadstats].to_d < 0.0
    Confline.set_value('DB_CPU_Loadstats', params[:db_hdd_loadstats].to_d.round(1))

    params[:db_hdd_mysql_process] = 1000 if params[:db_hdd_mysql_process].to_i > 1000
    params[:db_hdd_mysql_process] = 0 if params[:db_hdd_mysql_process].to_i < 0
    Confline.set_value('DB_CPU_MySQL_process', params[:db_hdd_mysql_process].to_i)

    params[:db_hdd_asterisk_process] = 1000 if params[:db_hdd_asterisk_process].to_i > 1000
    params[:db_hdd_asterisk_process] = 0 if params[:db_hdd_asterisk_process].to_i < 0
    Confline.set_value('DB_CPU_asterisk_process', params[:db_hdd_asterisk_process].to_i)

    params[:db_hdd_freeswitch_process] = 1000 if params[:db_hdd_freeswitch_process].to_i > 1000
    params[:db_hdd_freeswitch_process] = 0 if params[:db_hdd_freeswitch_process].to_i < 0
    Confline.set_value('DB_CPU_freeswitch_process', params[:db_hdd_freeswitch_process].to_i)

    params[:delete_server_load_stats] = 0 if params[:delete_server_load_stats].to_i < 0
    Confline.set_value('Delete_Server_Load_stats_older_than', params[:delete_server_load_stats].to_i)
    Confline.set_value('tariff_currency_in_csv_export', params[:tariff_currency_in_csv_export].to_i)

    allow_dynamic_op_auth_with_reg_initial_value = Confline.get_value('Allow_Dynamic_Origination_Point_Authentication_with_Registration').to_i
    allow_dynamic_origination_point_authentication_with_registration = params[:allow_dynamic_origination_point_authentication_with_registration].to_i
    Confline.set_value('Allow_Dynamic_Origination_Point_Authentication_with_Registration', allow_dynamic_origination_point_authentication_with_registration)
    if (allow_dynamic_op_auth_with_reg_initial_value == 1 && allow_dynamic_origination_point_authentication_with_registration == 0)
      ActiveRecord::Base.connection.execute('UPDATE devices SET dynamic = NULL')
      servers = Server.all
      servers.each do |server|
        begin
          server.fs_device_reload('')
        rescue StandardError, SystemExit
        end
      end
    end
    # /Server Load

    # PRIVACY settings
    Confline.set_value('Hide_Destination_End', params[:hide_destination_ends_gui].to_i + params[:hide_destination_ends_csv].to_i + params[:hide_destination_ends_pdf].to_i)
    # /PRIVACY settings

    # Number Portability
    Confline.set_value('Use_Number_Portability', params[:use_number_portability].to_i)
    Confline.set_value('MNP_Server_IP', params[:mnp_server_ip].to_s)
    Confline.set_value('MNP_Port', params[:mnp_port].to_i)

    %w[Username Password DB_NAME Table_Name Search_Field Result_Field].each do |param|
      param_value = params["mnp_#{param.downcase}".to_sym].to_s
      Confline.set_value("MNP_#{param}", param_value)
    end

    Confline.set_value('MNP_Supported_Prefixes', params[:mnp_supported_prefixes].to_i)
    # /Number Portability

    # Payments
    Confline.set_value('paypal_payments_activated', params[:paypal_payments_activated] ? 1 : 0)
    Confline.set_value('paypal_client_id', params[:paypal_client_id].to_s)
    Confline.set_value('secret_paypal_key', params[:secret_paypal_key].to_s)
    # /Payments

    user = User.where(id: session[:user_id]).first
    unless user
      flash[:notice] = _('User_not_found')
      redirect_to(:root) && (return false)
    end
    renew_session(user, {dont_change_date: true})
    if params[:enable_recaptcha].to_i == 1 and (params[:recaptcha_public_key].to_s.blank? or params[:recaptcha_private_key].to_s.blank?)
      flash[:notice] = _('reCAPTCHA_keys_cannot_be_empty')
      redirect_to(action: 'settings') && (return false)
    end
    flash[:status] = _('Settings_saved') if error.to_i == 0
    redirect_to(action: 'settings') && (return false)
  end

=begin rdoc
Sets default tax values for users

*Params*

<tt>u</tt> - 1 : set default taxes for users

*Flash*

<tt>notice</tt> - _('User_taxes_set_successfully') for users

*Redirects*

<tt>settings</tt> - after this action settings form is reopened.
=end

  def tax_change
    owner = correct_owner_id
    tax = {
        tax1_enabled: 1,
        tax2_enabled: Confline.get_value2('Tax_2', owner).to_i,
        tax3_enabled: Confline.get_value2('Tax_3', owner).to_i,
        tax4_enabled: Confline.get_value2('Tax_4', owner).to_i,
        tax1_name: Confline.get_value('Tax_1', owner),
        tax2_name: Confline.get_value('Tax_2', owner),
        tax3_name: Confline.get_value('Tax_3', owner),
        tax4_name: Confline.get_value('Tax_4', owner),
        total_tax_name: Confline.get_value('Total_tax_name', owner),
        tax1_value: Confline.get_value('Tax_1_Value', owner).to_d,
        tax2_value: Confline.get_value('Tax_2_Value', owner).to_d,
        tax3_value: Confline.get_value('Tax_3_Value', owner).to_d,
        tax4_value: Confline.get_value('Tax_4_Value', owner).to_d,
        compound_tax: Confline.get_value('Tax_compound', owner).to_i
    }

    tax[:total_tax_name] = 'TAX' if tax[:total_tax_name].blank?
    tax[:tax1_name] = tax[:total_tax_name].to_s if tax[:tax1_name].blank?

    case params[:u].to_i
      when 1
        users = User.includes(:tax).where(['owner_id = ?', owner]).all
        users.each { |user| user.assign_default_tax(tax, save: true)}
        Confline.set_default_object(Tax, owner, tax)
        flash[:status] = _('User_taxes_set_successfully')
      else
        dont_be_so_smart
    end

    if owner == 0
      redirect_to(action: 'settings') && (return false)
    else
      redirect_to(:root) && (return false)
    end
  end

  def style(stile)
    @ar = []
    @ar[0] = (stile >= 8) ? 8 : 0
    stile -= @ar[0]

    @ar[1] = (stile >= 6) ? 4 : 0
    stile -= @ar[1]

    @ar[2] = (stile >= 2) ? 2 : 0

    @ar
  end

  def update_confline(cline, value, id = 0)
    Confline.set_value(cline, value, id)
  end

  def update_confline2(cline, value, id = 0)
    Confline.set_value2(cline, value, id)
  end

  def translations
    @page_title = _('Translations')
    @page_icon = 'world.png'
    @help_link = 'http://wiki.ocean-tel.uk/index.php/Translations'
    @items = current_user.load_user_translations
  end

  def translations_sort
    params[:sortable_list].each_index do |index|
      item = UserTranslation.find(params[:sortable_list][index])
      item.update_attributes(position: index)
    end
    @items = current_user.load_user_translations
    render layout: false, action: :translations
  end

  def translations_change_status
    UserTranslation.translations_change_status(params[:id])
    @items = current_user.load_user_translations
    render layout: false, action: :translations
  end

  def translations_refresh
    flags_to_session
    redirect_to(action: 'translations') && (return false)
  end

  #============= INTEGRITY CHECK ===============

  def integrity_check
    @page_title = _('Integrity_check')
    @page_icon = 'lightning.png'
    @help_link = 'http://wiki.ocean-tel.uk/index.php/Integrity_Check'
    recheck_integrity_check
    @default_user_warning = false

    @destinations_without_dg = Destination.where('destinationgroup_id = 0').order('direction_code ASC')
    @actions = Action.joins(' JOIN users ON (actions.user_id = users.id) ').where("action = 'error' AND processed = '0' ")
    @devices = Device.where("LENGTH(secret) < 8 AND LENGTH(username) > 0 AND username NOT LIKE 'mor_server_%' AND user_id != -1")
    @users = User.where(["password = SHA1('') or password = SHA1(username)"])
    @default_users_erors = Confline.get_default_user_pospaid_errors
    if @default_users_erors and @default_users_erors.count.to_i > 0
      @default_user_warning = true
    end
    @users_postpaid_and_loss_calls = User.where('postpaid = 1 AND allow_loss_calls = 1')

    @insecure_devices = Device.where("insecure = 'port' ").all
    @server_space_exceeded = Server.where("hdd_free_space < #{server_free_space_limit} AND active = 1").all
    if @actions.size.to_i > 0
      @action = Action.joins(' JOIN users ON (actions.user_id = users.id) ').where("action = 'error' AND processed = '0' ").order('date ASC').first
      date = @action.date.to_time - 1.day
      session[:year_from] = date.year
      session[:month_from] = date.month
      session[:day_from] = date.day
      change_date
    end
  end

  def FunctionsController::integrity_recheck
    @destinations_without_dg = Destination.where(destinationgroup_id: 0).order('direction_code ASC').all
    return 1 unless @destinations_without_dg.empty?
    Confline.set_value('Integrity_Check', 0)
    return 0
  end

  # called from anywhere to check if everything is still ok/not_ok
  def FunctionsController::integrity_recheck_user(user_id = 0)
    @default_user_warning = false

    @default_user_warning = true if Confline.get_value('Default_User_allow_loss_calls', user_id).to_i == 1 and Confline.get_value('Default_User_postpaid', user_id).to_i == 1

    @users_postpaid_and_loss_calls = User.where(postpaid: 1, allow_loss_calls: 1).all

    return 1 if !@users_postpaid_and_loss_calls.empty? or @default_user_warning
    Confline.set_value('Integrity_Check', 0)
    return 0
  end

  ######### PERMISSIONS ##########################################################
  def permissions
    @page_title = _('Permissions')
    @page_icon = 'cog.png'
    @roles = Role.order(:name).all

    @rights = Right.includes([:role_rights]).order('saved DESC ,controller ASC , action ASC').all
    # @permissions = RoleRight.get_auth_list
    @roles_count = @roles.size
  end

  def permissions_save
    @roles = Role.order(:name).all
    @rights = Right.includes([:role_rights]).order('saved DESC ,controller ASC , action ASC').all

    Right.update_right_permissions(@rights)

    flash[:status] = _('Settings_saved')
    redirect_to action: 'permissions'
  end

  def role_new
    @page_title = _('New_Role')
    @page_icon = 'add.png'
    @role = Role.new
  end

  def role_create
    @role = Role.new(params[:role])
    if Role.where(name: @role.name).first
      flash[:notice] = _('Cannot_Create_Role_already_exists')
      redirect_to(action: 'permissions') && (return false)
    end

    if @role.save
      Right.update_role_rights(@role)
      flash[:status] = _('Role_Created')
      redirect_to action: 'role_new'
    else
      render :role_new
    end
  end

  def role_destroy
    @role = Role.find(params[:id])
    if User.where(usertype: @role.name).first
      flash[:notice] = _('Cannot_delete_role_users_exist')
      redirect_to(action: 'permissions') && (return false)
    end

    @role.destroy
    flash[:status] = _('Role_Destroyed')
    redirect_to(action: 'permissions') && (return false)
  end

  def right_new
    @page_title = _('New_Right')
    @page_icon = 'add.png'
    @right = Right.new
  end

  def right_create
    temp = params[:right]
    RoleRight.new_right(temp['controller'], temp['action'], temp['description'])
    flash[:status] = _('Right_Created')
    redirect_to action: 'right_new'
  end

  def right_destroy
    @right = Right.find(params[:id])
    @right.destroy
    flash[:status] = _('Right_Destroyed')
    redirect_to(action: 'permissions') && (return false)
  end

  def action_finder
    @controllers = Dir.new("#{Rails.root}/app/controllers").entries
  end

  def action_syncronise
    @roles = Role.order('name')
    @rights = Right.order('controller, action')
    @permissions = RoleRight.get_auth_list
    @roles_count = Role.count

    @controllers = Dir.new("#{Rails.root}/app/controllers").entries
    @controllers.each do |controller|
      if controller =~ /_controller/
        cont = controller.camelize.gsub('.rb', '')
        cont_short = cont.gsub('Controller', '').downcase
        (eval("#{cont}.new.methods") -
            ApplicationController.methods -
            Object.methods -
            ApplicationController.new.methods).sort.each { |met|
          RoleRight.new_right(cont_short, met.to_s, cont_short.to_s.capitalize + '_' + met.to_s)
        }
      end
    end

    redirect_to action: 'permissions'
  end

  def dump_permissions
    db_config = YAML.load_file(Actual_Dir + '/config/database.yml')
    `rm #{Actual_Dir.to_s}/doc/permissions.sql`
    `mysqldump --compact --add-drop-table -u #{db_config['development']['username']} -p#{db_config['development']['password']} mor roles rights role_rights >> #{Actual_Dir.to_s}/doc/permissions.sql`
    MorLog.my_debug('rm ' + Actual_Dir.to_s + '/doc/permissions.sql')
    MorLog.my_debug("mysqldump --compact --add-drop-table -u #{db_config['development']['username']} -p#{db_config['development']['password']} mor roles rights role_rights >> " + Actual_Dir.to_s + '/doc/permissions.sql')
    redirect_to action: 'permissions'
  end

  ######### /PERMISSIONS #########################################################
  ######### Get Not translated words #############################################

  def get_not_translated
    language = 'en'
    language = params[:language] if params[:language]
    lang = []
    @files = {}
    @new_lang = []
    File.read("#{Rails.root}/lang/#{language}.rb").scan(/l.store\s?[\'\"][^\'\"]+[\'\"]/) do |st|
      st.scan(/[\'\"][^\'\"]+[\'\"]/) do |st_item|
        lang << st_item.gsub(/[\'\"]/, '')
      end
    end

    @files_list = Dir.glob("#{Rails.root}/app/controllers/*.rb").collect
    @files_list += Dir.glob("#{Rails.root}/app/views/**/*.rhtml").collect
    @files_list += Dir.glob("#{Rails.root}/app/models/*.rb").collect
    @files_list += Dir.glob("#{Rails.root}/app/helpers/*.rb").collect
    @files_list += Dir.glob("#{Rails.root}/lib/**/*.rb").collect
    for file in @files_list
      File.read(file).scan(/[^\w\d]\_\([\'\"][^\'\"]+[\'\"]\)/) do |st|
        st = st.gsub(/.?\_\(/, '').gsub(/[\s\'\"\)\(]/, '')
        @new_lang << st
        @files[st] = file
      end
    end

    @new_lang -= lang
    @new_lang = @new_lang.uniq.flatten
  end

  ######### /Get Not translated words #############################################

  ######### IMPORT USER DATA FROM CSV ############################################

  def import_user_data
    @page_title = _('Import_user_data')
    @page_icon = 'excel.png'
    @users = User.where('temporary_id >= 0')
    @devices = Device.where("temporary_id >= 0 AND name not like 'mor_server_%'")
  end

  def import_user_data_clis
    @step = 1
    @step = params[:step].to_i if params[:step]

    @step_name = _('File_upload')
    @step_name = _('Column_assignment') if @step == 2
    @step_name = _('Column_confirmation') if @step == 3
    @step_name = _('Import_CLIs') if @step == 3

    @sep, @dec = Application.nice_action_session_csv(params, session, correct_owner_id)
    store_location
    @page_title = _('import_user_data_clis') + '&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;' + _('Step') + ': ' + @step.to_s + '&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;' + @step_name
    @page_icon = 'excel.png'
    session[:imp_cli_include] and @include = (session[:imp_cli_include] == 1) ? 1 : 0

    if @step == 2
      session[:imp_cli_include] = (params[:include].to_i == 1) ? 1 : 0

      if params[:file] or session[:file]
        if params[:file]
          if params[:file] == ''
            flash[:notice] = _('Please_select_file')
            redirect_to(action: 'import_user_data_clis', step: '1') && (return false)
          else
            @file = params[:file]
            if get_file_ext(@file.original_filename, 'csv') == false
              redirect_to(action: 'import_user_data_clis', step: '1') && (return false)
            end
            session[:file] = @file.read
          end
        else
          @file = session[:file]
        end

        session[:file_size] = @file.size
        if session[:file_size].to_i == 0
          flash[:notice] = _('Please_select_file')
          redirect_to(action: 'import_user_data_clis', step: '1') && (return false)
        end

        @file = session[:file]
        check_csv_file_seperators(@file, 2)
        arr = @file.split("\n")
        @fl = arr[0].split(@sep)
        flash[:status] = _('File_uploaded')
      end
    end

    if @step == 3
      if session[:file]
        @file = session[:file]
        session[:imp_cli_device_id] = params[:device_id].to_i if params[:device_id]
        session[:imp_cli_cli] = params[:cli].to_i if params[:cli]
        session[:imp_cli_device_id_type] = params[:device_id_type].to_i if params[:device_id_type]

        flash[:status] = _('Columns_assigned')
      end
    end

    if @step == 4
      inc = 1 - @include.to_i
      @error_array = []
      @msg_array = []
      if session[:file]
        array = []
        @file = session[:file]
        array = @file.split("\n")
        for arr in array
          if inc == 0
            row = []
            row = arr.split(@sep)
            r_arr = row
            err = ''

            device_id = clean_value_all(r_arr[session[:imp_cli_device_id]])
            cli = clean_value_all(r_arr[session[:imp_cli_cli]])

            if device_id.empty?
              err += _('Device_ID_Cant_Be_Empty') + '<br />'
            else
              device = (session[:imp_cli_device_id_type] == 0) ? Device.where("id = #{device_id.to_i}").first :
                 Device.where("temporary_id = #{device_id.to_i}").first
              err += _('Device_not_found') + '<br />' unless device
            end

            if cli.empty?
              err += _('CLI_Cant_Be_Empty') + '<br />'
            else
              callerid = Callerid.where("cli = '#{cli}'").first
              err += _('cli_already_exists') + '<br />' if callerid
            end

            if err == ''
              my_debug('ADDING')

              new_cli = Callerid.new(params[:cli])
              new_cli.assign_attributes(
                cli: cli,
                device: device,
                description: '',
                added_at: Time.now,
                banned: 0,
                created_at: Time.now,
                updated_at: Time.now,
                comment: ''
              )

              unless new_cli.save
                @error_array << arr
                msq = ''
                new_cli.errors.each { |key, value|
                  msq += "<br> * #{_(value)}"
                } if new_cli.respond_to?(:errors)
                @msg_array << msq
              end
            else
              @error_array << arr
              @msg_array << err
            end
          else
            inc = 0
          end
        end
      end
      if @error_array.blank?
        flash[:status] = _('CLIs_were_successfully_imported')
        redirect_to action: :import_user_data
      else
        flash[:notice] = _('There_were_errors')
      end
    end
  end

  def import_user_data_users
    @step = 1
    @step = params[:step].to_i if params[:step]

    @step_name = _('File_upload')
    @step_name = _('Column_assignment') if @step == 2
    @step_name = _('Column_confirmation') if @step == 3
    @step_name = _('Import_Users') if @step == 3

    @sep, @dec = Application.nice_action_session_csv(params, session, correct_owner_id)
    store_location
    @page_title = _('Import_user_data_users') + '&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;' + _('Step') + ': ' + @step.to_s + '&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;' + @step_name
    @page_icon = 'excel.png'
    session[:imp_user_include] and @include = (session[:imp_user_include] == 1) ? 1 : 0

    if @step == 2
      session[:imp_user_include] = (params[:include].to_i == 1) ? 1 : 0
      if params[:file] or session[:file]
        if params[:file]
          if params[:file] == ''
            flash[:notice] = _('Please_select_file')
            redirect_to(action: 'import_user_data_users', step: '1') && (return false)
          else
            @file = params[:file]
            if get_file_ext(@file.original_filename, 'csv') == false
              redirect_to(action: 'import_user_data_users', step: '1') && (return false)
            end
            session[:file] = @file.read
          end
        else
          @file = session[:file]
        end
        session[:file_size] = @file.size
        if session[:file_size].to_i == 0
          flash[:notice] = _('Please_select_file')
          redirect_to(action: 'import_user_data_users', step: '1') && (return false)
        end

        @file = session[:file]
        check_csv_file_seperators(@file, 6)
        arr = @file.split("\n")
        @fl = arr[0].split(@sep)
        flash[:status] = _('File_uploaded')
      end
    end

    if @step == 3
      if session[:file]
        @file = session[:file]
        session[:imp_user_temp_id] = params[:temp_id].to_i if params[:temp_id]
        session[:imp_user_username] = params[:username].to_i if params[:username]
        session[:imp_user_password] = params[:password].to_i if params[:password]
        session[:imp_user_first_name] = params[:first_name].to_i if params[:first_name]
        session[:imp_user_last_name] = params[:last_name].to_i if params[:last_name]
        session[:imp_user_payment_type] = params[:payment_type].to_i if params[:payment_type]
        session[:imp_user_personal_id] = params[:personal_id].to_i if params[:personal_id]
        session[:imp_user_vat_reg_number] = params[:vat_reg_number].to_i if params[:vat_reg_number]
        session[:imp_user_balance] = params[:balance].to_d if params[:balance]
        session[:imp_user_credit] = params[:credit].to_d if params[:credit]
        session[:imp_user_credit_unlimited] = params[:credit_unlimited].to_d if params[:credit_unlimited]
        session[:imp_user_address] = params[:address].to_i if params[:address]
        session[:imp_user_postcode] = params[:postcode].to_i if params[:postcode]
        session[:imp_user_city] = params[:city].to_i if params[:city]
        session[:imp_user_country] = params[:country].to_i if params[:country]
        session[:imp_user_state] = params[:state].to_i if params[:state]
        session[:imp_user_phone] = params[:phone].to_i if params[:phone]
        session[:imp_user_mob_phone] = params[:mob_phone].to_i if params[:mob_phone]
        session[:imp_user_fax] = params[:fax].to_i if params[:fax]
        session[:imp_user_email] = params[:email].to_i if params[:email]
        session[:imp_user_tariff] = params[:tariff].to_i if params[:tariff]

        flash[:status] = _('Columns_assigned')
      end
    end
    if @step == 4
      inc = 1 - @include.to_i
      @error_array = []
      @msg_array = []
      @warn_array = []
      @warn_msg = []
      if session[:file]
        array = []
        begin
          @file = session[:file].force_encoding('UTF-8')
          array = @file.split("\n")
        rescue
          @file = session[:file].force_encoding('ISO-8859-1').encode('utf-8', replace: nil)
          array = @file.split("\n")
        end
        array.each do |arr|
          if inc == 0
            row = []
            row = arr.split(@sep)
            r_arr = row
            err = ''
            warn = ''
            username = r_arr[session[:imp_user_username]].to_s.gsub("\"", '')

            if clean_value_all(r_arr[session[:imp_user_temp_id]]).to_i == ''
              err += _('Temp_User_ID_Cant_Be_Empty') + '<br />'
            end

            if username.empty?
              err += _('Please_enter_username') + '<br />'
            end
            if User.where(username: username).first
              err += _('Such_username_is_already_taken') + '<br />'
            end
            if clean_value_all(r_arr[session[:imp_user_password]]).length < 5
              err += _('Password_is_too_short') + '<br />'
            end
            if clean_value_all(r_arr[session[:imp_user_first_name]]).empty?
              err += _('Please_enter_first_name') + '<br />'
            end
            if clean_value_all(r_arr[session[:imp_user_last_name]]).empty?
              err += _('Please_enter_last_name') + '<br />'
            end
            if clean_value_all(r_arr[session[:imp_user_email]]).strip.empty?
              err += _('Please_enter_email') + '<br />'
            end
            if Address.where(email: (clean_value_all r_arr[session[:imp_user_email]]).strip).first
              err += _('Email_Must_Be_Unique')
            end
            unless Email.address_validation(clean_value_all(r_arr[session[:imp_user_email]]).strip)
              err += _('Please_enter_valid_email') + '<br />'
            end

            if err == ''
              address = Address.assign_imported_address(r_arr, session)
              address.save

              user = User.new(
                imported_user: true,
                temporary_id: clean_value_all(r_arr[session[:imp_user_temp_id]]).to_i,
                username: clean_value_all(r_arr[session[:imp_user_username]]),
                password: Digest::SHA1.hexdigest(clean_value_all(r_arr[session[:imp_user_password]]))
              )
              my_debug('Password:')
              my_debug(clean_value_all(r_arr[session[:imp_user_password]]))

              user.is_user?
              user.postpaid = session[:imp_user_payment_type] ?
                  clean_value_all(r_arr[session[:imp_user_payment_type]]).to_i : 0
              user.balance = clean_value_all(r_arr[session[:imp_user_balance]]) if session[:imp_user_balance] >= 0
              user.credit = clean_value_all(r_arr[session[:imp_user_credit]]) if session[:imp_user_credit] >= 0
              user.credit = clean_value_all(r_arr[session[:imp_user_credit_unlimited]]) if session[:imp_user_credit_unlimited] >= 0
              user.first_name = clean_value_all r_arr[session[:imp_user_first_name]]
              user.last_name = clean_value_all r_arr[session[:imp_user_last_name]]

              if session[:imp_user_tariff] >= 0
                tariff_id = clean_value_all(r_arr[session[:imp_user_tariff]]).to_i
                if Tariff.where(id: tariff_id).first
                  user.tariff_id = tariff_id
                else
                  warn += _('Tariff_Was_Not_Found_Default_Assigned') + '<br />'
                  user.tariff_id = Confline.get_value('Tariff_for_registered_users').to_i
                end
              else
                user.tariff_id = Confline.get_value('Tariff_for_registered_users').to_i
              end

              user.clientid =clean_value_all r_arr[session[:imp_user_personal_id]] if session[:imp_user_personal_id] > 0
              user.agreement_date = Time.now
              user.agreement_number = next_agreement_number
              user.taxation_country = Direction.get_direction_by_country(clean_value_all(r_arr[session[:imp_user_country]]))
              user.vat_number = clean_value_all r_arr[session[:imp_user_vat_reg_number]] if session[:imp_user_vat_reg_number] >= 0

              user.address_id = address.id
              user.owner_id = 0
              unless user.save
                user.errors.each { |key, value|
                  MorLog.my_debug("#{key} - #{value}")
                }

              end

              user.assign_default_tax
              if warn != ''
                @warn_array << arr
                @warn_msg << warn
                my_debug(@warn_msg)
                my_debug(@warn_array)
              end
            else
              @error_array << arr
              @msg_array << err
            end
          else
            inc = 0
          end
        end
      end
      if @error_array.blank?
        flash[:status] = _('Users_were_successfully_imported')
        redirect_to action: :import_user_data
      else
        flash[:notice] = _('There_were_errors')
      end
    end
  end

  def import_user_data_devices
    @step = 1
    @step = params[:step].to_i if params[:step]

    @step_name = _('File_upload')
    @step_name = _('Column_assignment') if @step == 2
    @step_name = _('Column_confirmation') if @step == 3
    @step_name = _('Import_Devices') if @step == 4

    @sep, @dec = Application.nice_action_session_csv(params, session, correct_owner_id)
    store_location
    @page_title = _('Import_user_data_devices') + '&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;' + _('Step') + ': ' + @step.to_s + '&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;' + @step_name
    @page_icon = 'excel.png'
    session[:imp_device_include] and @include = (session[:imp_device_include] == 1) ? 1 : 0
    if @step == 2
      session[:imp_device_include] = (params[:include].to_i == 1) ? 1 : 0
      if params[:file] or session[:file]
        if params[:file]
          if params[:file] == ''
            flash[:notice] = _('Please_select_file')
            redirect_to(action: 'import_user_data_devices', step: '1') && (return false)
          else
            @file = params[:file]
            if get_file_ext(@file.original_filename, 'csv') == false
              redirect_to(action: 'import_user_data_devices', step: '1') && (return false)
            end
            session[:file] = @file.read
          end
        else
          @file = session[:file]
        end
        session[:file_size] = @file.size
        if session[:file_size].to_i == 0
          flash[:notice] = _('Please_select_file')
          redirect_to(action: 'import_user_data_devices', step: '1') && (return false)
        end

        @file = session[:file]
        check_csv_file_seperators(@file, 8)
        arr = @file.split("\n")
        @fl = arr[0].split(@sep)
        flash[:status] = _('File_uploaded')
      end
    end

    if @step == 3
      if session[:file]
        @file = session[:file]
        session[:imp_device_temp_device_id] = params[:temp_device_id].to_i if params[:temp_device_id]
        session[:imp_device_temp_user_id] = params[:temp_user_id].to_i if params[:temp_user_id]
        session[:imp_device_username] = params[:username].to_i if params[:username]
        session[:imp_device_password] = params[:password].to_i if params[:password]
        session[:imp_device_host] = params[:host].to_i if params[:host]
        session[:imp_device_cli_name] = params[:cli_name].to_i if params[:cli_name]
        session[:imp_device_cli_number] = params[:cli_number].to_i if params[:cli_number]
        session[:imp_device_type] = params[:device_type].to_i if params[:device_type]
        session[:imp_device_extension] = params[:extension].to_i if params[:extension]
        session[:imp_device_pin] = params[:pin].to_i if params[:pin]

        flash[:status] = _('Columns_assigned')
      end
    end

    if @step == 4
      inc = 1 - @include.to_i
      @error_array = []
      @msg_array = []
      if session[:file]
        array = []
        @file = session[:file]
        array = @file.split("\n")
        for arr in array
          if inc == 0
            row = []
            row = arr.split(@sep)
            r_arr = row
            err = ''

            device_type = clean_value_all(r_arr[session[:imp_device_type]])
            device_temp_id = clean_value_all(r_arr[session[:imp_device_temp_device_id]])
            user_temp_id = clean_value_all(r_arr[session[:imp_device_temp_user_id]])
            cli_name = clean_value_all(r_arr[session[:imp_device_cli_name]])
            cli_number = clean_value_all(r_arr[session[:imp_device_cli_number]])
            device_extension = clean_value_all(r_arr[session[:imp_device_extension]])
            pin = clean_value_all(r_arr[session[:imp_device_pin]])

            if device_temp_id.empty?
              err += _('Temp_Device_ID_Cant_Be_Empty') + '<br />'
            else
              device = Device.where("temporary_id = #{device_temp_id.to_i}").first
              err += _('Temp_Device_ID_Already_Taken') + '<br />' if device
            end

            if user_temp_id.empty?
              err += _('Temp_User_ID_Cant_Be_Empty') + '<br />'
            else
              user = User.where("temporary_id = #{user_temp_id.to_i}").first
              err += _('User_Was_Not_Found') + '<br />' unless user
            end

            if device_type.upcase != 'SIP'
              err += _('Invalid_Device_type') + '<br />'
            elsif device_type.upcase == 'SIP'
                port = 5060
            else
                port = 0
            end

            if device_extension.empty?
              err += _('Device_Extension_Cant_Be_Empty') + '<br />'
            elsif nil != Device.where(extension: device_extension).first
              err += _('Device_Extension_Must_Be_Unique') + '<br />'
            end

            if clean_value_all(r_arr[session[:imp_device_password]]).empty?
              err += _('Password_cant_be_empty') + '<br />'
            end

            if clean_value_all(r_arr[session[:imp_device_username]]).empty?
              err += _('Username_Cant_Be_Empty') + '<br />'
            end

            if clean_value_all(r_arr[session[:imp_device_host]]).empty?
              err += _('Host_Cant_Be_Empty') + '<br />'
            end

            if cli_name.empty?
              err += _('CLI_Name_Cant_Be_Empty') + '<br />'
            end
            if cli_number.empty?
              err += _('CLI_Number_Cant_Be_Empty') + '<br />'
            end

            if err == ''
              my_debug('ADDING')
              device = Device.new(params[:device])
              device.assign_attributes(
                user: user,
                temporary_id: device_temp_id,
                context: 'mor_local',
                extension: clean_value_all(r_arr[session[:imp_device_extension]]),
                name: clean_value_all(r_arr[session[:imp_device_username]]),
                username: clean_value_all(r_arr[session[:imp_device_username]]),
                secret: clean_value_all(r_arr[session[:imp_device_password]]),
                pin: (pin == '') ? params[:device][:pin] : pin,
                device_type: (device_type.upcase if ['SIP'].include?(device_type.upcase)),
                permit: '0.0.0.0/0.0.0.0',
                host: clean_value_all(r_arr[session[:imp_device_host]]),
                port: port,
                istrunk: 0,
                ani: 0,
                qualify: Confline.get_value('Default_device_qualify', session[:user_id]),
                call_limit: Confline.get_value('Default_device_call_limit', session[:user_id]),
                callgroup: nil,
                pickupgroup: nil,
                fromuser: nil,
                fromdomain: nil,
                insecure: nil,
                callerid: "\"#{cli_name}\"<#{cli_number}>"
              )
              device.save
              device.accountcode = device.id
              if device.save
                return false unless configure_extensions(device.id, current_user: current_user)
              else
                @error_array << arr
                msq = ''
                device.errors.each { |key, value|
                  msq += "<br> * #{_(value)}"
                } if device.respond_to?(:errors)
                @msg_array << msq
              end
            else
              @error_array << arr
              @msg_array << err
            end
          else
            inc = 0
          end
        end
      end
      if @error_array.blank?
        flash[:status] = _('Devices_were_successfully_imported')
        redirect_to action: :import_user_data
      else
        flash[:notice] = _('There_were_errors')
      end
    end
  end

  def clean_value(value)
    cv = value.to_s
    cv = cv[1..cv.length] if cv[0, 1] == "\""
    cv = cv[0..cv.length - 2] if cv[cv.length - 1, 1] == "\""
    cv
  end

  def import_user_data_clear
    database = ActiveRecord::Base.connection

    sql = 'UPDATE users SET temporary_id = NULL'
    sql2 = 'UPDATE devices SET temporary_id = NULL'
    database.execute(sql)
    database.execute(sql2)
    flash[:status] = _('Temporary_information_cleared')
    redirect_to(action: 'import_user_data') && (return false)
  end

  def clean_value_all(value)
    cv = value.to_s
    while cv[0, 1] == "\"" or cv[0] == "'" do
      cv = cv[1..cv.length]
    end
    while cv[cv.length - 1, 1] == "\"" or cv[cv.length - 1, 1] == "'" do
      cv = cv[0..cv.length - 2]
    end
    cv
  end

  #=============== Click2Call from web ===========

  def call_to
    @number = params[:number]
    user_id = session[:user_id]
    user = User.find(user_id)

    @error = ''
    device = user.primary_device

    if device
      src = device.extension
      dst = @number
      server = 1
      channel = "Local/#{src}@mor_cb_src/n"
      st = originate_call(device.id, channel, 'mor_cb_dst', dst, device.callerid_number, nil, server)
      @error = _('Cannot_connect_to_core_server') if st.to_i != 0
    else
      @error = _('No_device')
    end

    render(layout: false)
  end

  def test_text
    @text = params[:text]
  end

  def test_file_upload
    @page_title = 'Test file upload'
    @page_icon = 'lightning.png'

    @step = 1
    @step = params[:step].to_i if params[:step]

    @sep, @dec = Application.nice_action_session_csv(params, session, correct_owner_id)
    store_location

    if @step == 2
      session[:imp_user_include] = (params[:include].to_i == 1) ? 1 : 0
      if params[:file] or session[:file]
        if params[:file]
          if params[:file] == ''
            flash[:notice] = _('Please_select_file')
            redirect_to(action: 'import_user_data_users', step: '1') && (return false)
          else
            @file = params[:file]
            if get_file_ext(@file.original_filename, 'csv') == false
              redirect_to(action: 'import_user_data_users', step: '1') && (return false)
            end
            session[:file] = @file.read
          end
        else
          @file = session[:file]
        end
        session[:file_size] = @file.size
        if session[:file_size].to_i == 0
          flash[:notice] = _('Please_select_file')
          redirect_to(action: 'import_user_data_users', step: '1') && (return false)
        end

        @file = session[:file]
        check_csv_file_seperators(@file)
        arr = @file.split("\n")
        @fl = arr[0].split(@sep)
        flash[:status] = _('File_uploaded')
      end
    end

    if @step == 3
      `rm -rf /tmp/mor/*`
      @step = 1
      flash[:status] = _('Files_deleted')
    end
  end

  def check_separator
    if session[:file].blank?
      flash[:notice] = _('Please_select_file')
      redirect_back_or_default('/callc/main') and return false
    else
      file = session[:file].force_encoding('UTF-8')
      sep = (params[:custom].to_i > 0) ? (params[:sepn].presence || ';') : params[:sepn2]
      arr = file.split("\n")
      @fl = []
      5.times { |num| @fl[num] = arr[num].to_s.split(sep.to_s) }
      if @fl[0].size.to_i < params[:min_collum_size].to_i
        @notice = _('Not_enough_columns_check_csv_separators')
      end
      render layout: false
    end
  end

  def generate_hash
    @page_title = _('Generate_hash')
    if admin?
      @api_link = params[:link].to_s
      if @api_link.present?
        @query_values = {}
        begin
          CGI::parse(URI.parse(@api_link).query).each { |key, value| @query_values[key.to_sym] = value[0] }
          flash[:notice] = nil
        rescue
          flash[:notice] = _('failed_to_parse_uri') + ' ' + @api_link
        end
        api_action = @query_values.present? ? @query_values[:api_path].to_s.split('/').last : ''
        dummy, ret, @hash_param_order = MorApi.hash_checking(@query_values, dummy, api_action)
        if ret[:key] == ''
          flash[:notice] = _('api_must_have_secret_key')
        else
          @api_secret_key = ret[:key]
          @system_hash = ret[:system_hash]
        end
      end
    else
      dont_be_so_smart
      redirect_to :root
    end
  end

  def ccl_settings
    unless ccl_active?
      dont_be_so_smart
      redirect_to(:root) && (return false)
    end

    @page_title = _('CCL_Settings')
    @page_icon = 'cog.png'
    @help_link = 'http://wiki.ocean-tel.uk/index.php/'

    unless admin?
      redirect_to(action: :main) && (return false)
    end

    @servers = Server.where(server_type: 'asterisk')
  end

  def ccl_settings_update
    unless ccl_active?
      dont_be_so_smart
      redirect_to(:root) && (return false)
    end
    if params[:indirect].to_i == 1
      if params[:s_id].present?
        Confline.set_value('Default_asterisk_server', params[:s_id], current_user.get_corrected_owner_id)
        flash[:status] = _('Settings_saved')
        redirect_to action: :ccl_settings
      else
        flash[:notice] = _('Update_failed')
        redirect_to(action: :ccl_settings) && (return false)
      end
    else
      redirect_to action: :main and return false
    end
  end

  def background_tasks
    @page_title	= _('Background_tasks')
    @page_icon	= 'cog.png'
    @help_link	= 'http://wiki.ocean-tel.uk/index.php/Background_Tasks'

    clean_params = params.dup.symbolize_keys.reject { |key, _| [:controller, :action].member? key }
    @options = {}.merge(clean_params)
    @options[:page]	= 1	if @options[:page].blank?
    @options[:order_by]	= 'created_at' if @options[:order_by].blank? # #9683 "CASE status when 'IN PROGRESS' then 1 END"
    @options[:order_desc] = 1 if @options[:order_desc].blank?

    order_by = @options[:order_by] + ' ' + ['ASC', 'DESC'][@options[:order_desc].to_i]
    @tasks_all = BackgroundTask.order(order_by).all

    page_limit = session[:items_per_page] || 50
    page_offset = page_limit.to_i * (@options[:page].to_i - 1)

    @tasks = @tasks_all[page_offset, page_limit].to_a
    @total_pages = (@tasks_all.size / page_limit.to_d).ceil

    # pagination fix if last element deleted on the last page or page in params is higher than total
    if not @total_pages.zero? and @total_pages < @options[:page].to_i
      @options[:page]	= @total_pages
      redirect_to(action: 'background_tasks', params: @options) && (return false)
    end

    @show_delete  = Proc.new { |task| ['DONE', 'WAITING'].member? task.status }
    @show_restart = Proc.new { |task| ['DONE', 'FAILED'].member? task.status }
    @nice_task    = Proc.new do |task|
      case task.task_id
        when 1 then _('Rerating')
        when 2 then _('Archive_Old_Calls')
        when 3 then _('tariff_generation')
        when 4 then _('Generating_invoice')
        when 5 then _('Recalculating_invoice')
        when 7 then _('CDR_Export')
        when 8 then _('CDR_Dispute')
        else _('Unknown')
      end
    end
  end

  def task_delete
    @task = BackgroundTask.find(params[:id])
    @task.destroy

    new_params	= params.dup.symbolize_keys.reject { |key, _| [:id, :controller, :action].member? key }

    flash[:status] = _('task_deleted')
    redirect_to action: 'background_tasks', params: new_params
  end

  def task_restart
    task = BackgroundTask.find(params[:id])

    if task
      task_updated = task.update_attributes(status: 'WAITING', percent_completed: 0, expected_to_finish_at: nil, finished_at: nil)
      new_params = params.dup.symbolize_keys.reject { |key, _| [:id, :controller, :action].member? key }

      if task_updated
        flash[:status] = _('task_restarted')
        system('/usr/local/m2/m2_invoices generate &') if task.task_id.to_i == 4
      else
        flash[:notice] = _('task_not_restarted')
      end
    else
      flash[:notice] = _('task_not_restarted')
    end

    redirect_to action: 'background_tasks', params: new_params
  end

  def get_mnp_prefixes
    prefixes = MnpPrefix.all

    respond_to do |format|
      format.json { render(json: prefixes) }
    end
  end

  def create_mnp_prefix
    mnp_prefix = MnpPrefix.new(prefix: params[:prefix])

    response = {status: 0}
    if mnp_prefix.save
      response[:msg] = _('MNP_Prefix_succesfully_created')
    else
      response[:msg] = _('MNP_prefix_was_not_created')
      response[:errors] = mnp_prefix.errors
      response[:status] = 1
    end

    respond_to do |format|
      format.json { render(json: response) }
    end
  end

  def destroy_mnp_prefix
    prefix = MnpPrefix.where(id: params[:id].try(:to_i)).first

    response = {status: 0}
    if prefix && prefix.destroy
      response[:msg] = _('MNP_Prefix_was_succesfully_deleted')
    else
      response[:msg] = prefix.blank? ? _('MNP_Prefix_was_not_found') : _('MNP_Prefix_was_not_deleted')
      response[:status] = 1
    end

    respond_to do |format|
      format.json { render(json: response) }
    end
  end

  def test_mnp_db_connection
    response = 'ok'
    begin
      client = Mysql2::Client.new(host: params[:host], port: params[:port], username: params[:username], password: params[:mnp_password], database: params[:db_name])
      query = "SELECT #{ActiveRecord::Base::sanitize("#{params[:search_field]}")[1..-2]},
                      #{ActiveRecord::Base::sanitize("#{params[:result_field]}")[1..-2]}
               FROM  #{ActiveRecord::Base::sanitize("#{params[:table_name]}")[1..-2]}
               LIMIT 1"
      client.query(query)
    rescue Mysql2::Error => error
      response = "Mysql2::Error: #{error.error_number}"
    end

    response = {msg: response, color: response == 'ok' ? '#c9efb9' : '#FFD4D4'}
    respond_to do |format|
      format.json { render(json: response) }
    end
  end

  #================= PRIVATE ==================

  private

  def find_user
    @user = User.find_by(id: params[:user])
    return if @user.present?

    flash[:notice] = _('User_was_not_found')
    redirect_to(action: :index) && (return false)
  end

=begin rdoc
  if user wants to enable api key MUST enter at least 6 symbol key. if he disables api
  he may set valid api(at least 6 symbols) or not set at all

  *params*
  <tt>allow</tt> - true or false depending on what user wants
  <tt>key</tt> - secret api key
  *return*
  true if invalid or false if valid
=end
  def invalid_api_params?(allow_api, key)
    if allow_api
      key.to_s.length < 6
    else
      (1...6).include?(key.to_s.length)
    end
  end

  def validate_range(value, min, max, min_def = nil, max_def = nil)
    min_def ||= min.to_d
    max_def ||= max.to_d
    value = min_def.to_d if value.to_d < min.to_d
    value = max_def.to_d if value.to_d > max.to_d

    value
  end

  def direction_by_dst(dst)
    sql = 'SELECT directions.name AS direction_name, destinationgroups.name AS destinationgroup_name ' +
          'FROM directions JOIN destinations ON directions.code = destinations.direction_code ' +
          'LEFT JOIN destinationgroups ON destinations.destinationgroup_id = destinationgroups.id ' +
          "WHERE  destinations.prefix=SUBSTRING('#{dst}', 1, LENGTH(destinations.prefix)) " +
          'ORDER BY LENGTH(destinations.prefix) DESC LIMIT 1'
    res = ActiveRecord::Base.connection.select_all(sql)
    array = [_('Unknown'), _('Unknown')]

    if res and res[0]
      array[0] = res[0]['direction_name'] if res[0]['direction_name'].present?
      array[1] = res[0]['destinationgroup_name'] if res[0]['destinationgroup_name'].present?
    end

    array
  end

  def sanitize_filename(file_name)
    # get only the filename, not the whole path (from IE)
    just_filename = File.basename(file_name)
    # replace all none alphanumeric, underscore or perioids with underscore
    just_filename.gsub(/[^\w\.\_]/, '_')
  end

  def set_valid_page_limit(field, limit, user)
    # required parameters:
    # field - expected values "Prepaid_Invoice_page_limit", "Invoice_page_limit".
    # limit - page limit. gots to be integer at least as smal as default page limit. if to small or smth else was passed set to default page limit
    # user - user id, gots to be integer. 0 for admin, 1 or more for others. theres no way to pretend that user id might be default in case it isn't valid
    default_page_limit = 1
    limit = (limit.to_i < default_page_limit) ? default_page_limit : limit.to_i
    Confline.set_value(field, limit, user)
  end

  def admin_only
    unless admin? || manager?
      flash[:notice] = _('Dont_be_so_smart')
      redirect_to :root and return false
    end
  end

  def test_email_admin_only
    unless admin?
      flash[:notice] = _('You_are_not_authorized_to_view_this_page')
      redirect_to(:root) && (return false)
    end
  end

  def check_pbx_addon
    unless pbx_active?
      flash[:notice] = _('You_are_not_authorized_to_view_this_page')
      redirect_to(:root) && (return false)
    end
  end

  def disable_xss_protection
    # Disabling this is probably not a good idea,
    # but the header causes Chrome to choke when being
    # redirected back after a submit and the page contains an iframe.
    response.headers['X-XSS-Protection'] = '0'
  end

  def copy_file(directory, name = params[:file].original_filename)
    if params[:file].present?
      path = File.join(directory, name)
      File.open(path, 'wb') { |file| file.write(params[:file].read) }
    end
  end

  def delete_generated_invoice_xlsx_files(user_id)
    numbers = M2Invoice.invoice_numbers_by_owner_id(user_id).map { |number| "/tmp/m2/invoices/#{number}.{xlsx,pdf}" }
    numbers.in_groups_of(20, false) do |numbers_group|
      `rm -rf #{numbers_group.join(' ')}`
    end
  end

  def check_if_request_ajax
    unless request.xhr?
      flash[:notice] = _('Dont_be_so_smart')
      redirect_to(:root) && (return false)
    end
  end
end
